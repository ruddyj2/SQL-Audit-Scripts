*   [![mssqltips logo](/images/mslogo_bw_89x45-2.png)](https://www.mssqltips.com/)
*   [Menu](#)

*   [Join](/get-free-sql-server-tips/?ref=JoinHeaderMenu)
*   [Beginner](#)
    *   ##### [Back](javascript:void(0))
        
    *   [Beginner](#)
    *   [What is SQL Server?](/sqlservertip/1948/sql-server/)
    *   [SQL Server 101](/sqlservertutorial/9214/sql-server-101-tutorial-outline-and-overview/)
    *   [SQL Server Concepts](/sqlservertip/6422/sql-server-concepts/)
    *   [SQL Server Download Links](/sqlservertip/6429/sql-server-download-quick-links/)
    *   [My First BI Project](/sqlservertutorial/3700/my-first-sql-server-business-intelligence-project-tutorial/)
    *   [SQL Server Career Plan](/sqlservertip/2677/sql-server-career-planning/)
    *   [Webinars](/sql-server-webcasts/)
    *   [All Categories](/sql-server-categories/)
*   [Tutorials](#)
    *   ##### [Back](javascript:void(0))
        
    *   [Tutorials](#)
    *   [SQL Server 101](/sqlservertutorial/9214/sql-server-101-tutorial-outline-and-overview/)
    *   [Stored Procedures](/sqlservertutorial/160/sql-server-stored-procedure-tutorial/)
    *   [Performance Tuning](/sqlservertutorial/276/sql-server-performance-tuning-and-monitoring-tutorial/)
    *   [Indexing](/sqlservertutorial/9131/sql-server-index-tutorial-overview/)
    *   [Integration Services](/sqlservertutorial/9053/sql-server-integration-services-ssis-2016-tutorial/)
    *   [Reporting Services](/sqlservertutorial/9079/sql-server-reporting-services-ssrs-2017-installation-and-configuration-setup/)
    *   [All Tutorials](/sql-server-tutorials/)
*   [DBA](#)
    *   ##### [Back](javascript:void(0))
        
    *   [DBA](#)
    *   [Database Administration](/sql-server-tip-category/60/database-administration/)
    *   [Performance Tuning](/sqlservertutorial/276/sql-server-performance-tuning-and-monitoring-tutorial/)
    *   [Monitoring](/sql-server-tip-category/54/monitoring/)
    *   [Extended Events](/sqlservertutorial/9194/sql-server-extended-events-tutorial/)
    *   [PowerShell](/sql-server-tip-category/81/powershell/)
    *   [SQL Server Agent](/sql-server-tip-category/27/sql-server-agent/)
    *   [Management Studio](/sqlservertutorial/9268/sql-server-management-studio-overview-ssms/)
    *   [Backup](/sql-server-tip-category/161/backup/)
    *   [Restore](/sql-server-tip-category/202/restore/)
    *   [Availability Groups](/sql-server-tip-category/143/availability-groups/)
    *   [Webinars](/sql-server-webcasts/)
    *   [All Categories](/sql-server-categories/)
*   [T-SQL](#)
    *   ##### [Back](javascript:void(0))
        
    *   [T-SQL](#)
    *   [Stored Procedure Tutorial](/sqlservertutorial/160/sql-server-stored-procedure-tutorial/)
    *   [SQL Server Join Example](/sqlservertip/1667/sql-server-join-example/)
    *   [CROSS APPLY + OUTER APPLY](/sqlservertip/1958/sql-server-cross-apply-and-outer-apply/)
    *   [Cursor in SQL Server](/sqlservertip/1599/cursor-in-sql-server/)
    *   [Rolling up multiple rows](/sqlservertip/2914/rolling-up-multiple-rows-into-a-single-row-and-column-for-sql-server-data/)
    *   [Execute Dynamic SQL](/sqlservertip/1160/execute-dynamic-sql-commands-in-sql-server/)
    *   [Date and Time Conversions](/sqlservertip/1145/date-and-time-conversions-using-sql-server/)
    *   [Format SQL Server Dates](/sqlservertip/2655/format-sql-server-dates-with-format-function/)
    *   [Calendar Table](/sqlservertip/4054/creating-a-date-dimension-or-calendar-table-in-sql-server/)
    *   [Add and Subtract Dates](/sqlservertip/2509/add-and-subtract-dates-using-dateadd-in-sql-server/)
    *   [Date and Time Functions](/sqlservertip/5993/sql-server-date-and-time-functions-with-examples/)
    *   [Webinars](/sql-server-webcasts/)
    *   [All Categories](/sql-server-categories/)
*   [Analytics](#)
    *   ##### [Back](javascript:void(0))
        
    *   [Analytics](#)
    *   [Power BI](/sql-server-tip-category/211/power-bi/)
    *   [Integration Services](/sqlservertutorial/9053/sql-server-integration-services-ssis-2016-tutorial/)
    *   [Azure Data Factory](/sql-server-tip-category/245/azure-data-factory/)
    *   [Reporting Services](/sqlservertutorial/9079/sql-server-reporting-services-ssrs-2017-installation-and-configuration-setup/)
    *   [Analysis Services](/sqlservertutorial/4200/sql-server-analysis-services-2016-ssas-tutorial/)
    *   [Python](/sqlservertutorial/9073/sql-server-2017-and-python-basics/)
    *   [R](/sqlservertutorial/9040/getting-started-with-r-in-sql-server/)
    *   [Webinars](/sql-server-webcasts/)
    *   [All Categories](/sql-server-categories/)
*   [Cloud](#)
    *   ##### [Back](javascript:void(0))
        
    *   [Cloud](#)
    *   [AWS](/sql-server-tip-category/205/amazon-aws/)
    *   [Azure](/sql-server-tip-category/87/azure/)
    *   [All Categories](/sql-server-categories/)
*   [Tools](#)
    *   ##### [Back](javascript:void(0))
        
    *   [Tools](#)
    *   [Data Quality Tools](/sqlservertip/6297/melissa-data-quality-solutions-for-ssis/?ps=melissa)
    *   [SQL Diagnostic Manager for SQL Server](/sqlservertip/6845/sql-diagnostic-manager-for-sql-server/?ps=sql-dm)
    *   [DBI Web Performance Suite](/sqlservertip/7224/dbi-performance-suite-for-db2-and-sql-server/?ps=dbi-software)
    *   [Clumio SQL Server backups for AWS](/sqlservertip/7845/clumio-sql-backups-built-for-dbas-loved-by-it/?ps=clumio)
    *   [SQLGrease - Deep Query Tuning](/sqlservertip/7891/sql-server-query-optimization-from-sqlgrease/?ps=sqlgrease)
*   [Search](/search/)

SQL Server Security Audit (Part 2): Scripts to help you or where can you find more information
==============================================================================================

By: [Svetlana Golovko](/sqlserverauthor/94/svetlana-golovko/ "author profile for Svetlana Golovko")   |   [Comments (13)](#comments "read and post comments")   |   Related: > [Auditing and Compliance](/sql-server-tip-category/35/auditing-and-compliance/)

  

##### Problem

The first article (["Part 1"](/sqlservertip/2801/sql-server-database-security-audit-part-1-what-to-expect/)) listed some of the checks for the database security audit. In this tip we look at many different security settings and configuration settings that you should be aware of.  There are several scripts that you can run to know if there are any potential security issues on your servers.

##### Solution

The scripts listed below will help you configure several of the security options on SQL Server and also run some of the checks to see if there are potential issues.

### Check SQL Server Audit level

This will check to see what your current login audit level is set to capture.

DECLARE @AuditLevel int
EXEC master.dbo.xp\_instance\_regread N'HKEY\_LOCAL\_MACHINE', 
   N'Software\\Microsoft\\MSSQLServer\\MSSQLServer', 
   N'AuditLevel', @AuditLevel OUTPUT
SELECT CASE WHEN @AuditLevel = 0 THEN 'None'
   WHEN @AuditLevel = 1 THEN 'Successful logins only'
   WHEN @AuditLevel = 2 THEN 'Failed logins only'
   WHEN @AuditLevel = 3 THEN 'Both failed and successful logins' 
   END AS \[AuditLevel\] 

### Configure number of SQL Server logs

This script will change the setting so that you stored 48 SQL Server error log archives.  This will allow us to have a good amount of history from our error logs.

EXEC master.dbo.xp\_instance\_regwrite N'HKEY\_LOCAL\_MACHINE', 
       N'Software\\Microsoft\\MSSQLServer\\MSSQLServer', 
       N'NumErrorLogs', REG\_DWORD, 48

Read this [tip](/sqlservertip/1835/increase-the-number-of-sql-server-error-logs/) if you want to configure the number error log files using SQL Server Management Studio (SSMS). Refer to [tip](/sqlservertip/1155/sql-server-2005-error-log-management/) for more information about log files management and configuration.

### Create alert, operator and notification for the security events

We will setup these components so when there is an issue we can be alerted by SQL Server.

Create operator:

EXEC msdb.dbo.sp\_add\_operator @name=N'NotifyDBA\_Group', 
  @enabled=1, 
  @email\_address=N'NotifyDBAs@company.com'

Create alert for severity 14 events (these are security related errors):

EXEC msdb.dbo.sp\_add\_alert @name = N'Sev. 14 Errors - Permissions', 
  @severity = 14, 
  @include\_event\_description\_in = 1

Create notification:

EXEC msdb.dbo.sp\_add\_notification @alert\_name = N'Sev. 14 Errors - Permissions', 
@operator\_name = N'NotifyDBA\_Group', @notification\_method = 1

Use this [tip](/sqlservertip/1523/how-to-setup-sql-server-alerts-and-email-operator-notifications) if you prefer to configure alerts and operators using SSMS.

### Find failed login events in SQL Server error log

This will allow us to search the SQL Server error log for failed logins.  This command below will search the active SQL Server error log.

EXEC master.dbo.xp\_readerrorlog 0, 1, 'login failed', null, NULL, NULL, N'desc'

Refer to this [tip](/sqlservertip/1476/reading-the-sql-server-log-files-using-tsql/) if you want to learn more about xp\_readerrorlog extended stored procedure and it's usage as well as how to read the archived SQL Server error logs.

### Check that Builtin\\Administrators group removed from sysadmins role

This command will check to see if the builtin administrator account has been removed.

SELECT r.name  as SrvRole, u.name  as LoginName  
FROM sys.server\_role\_members m JOIN
  sys.server\_principals r ON m.role\_principal\_id = r.principal\_id  JOIN
  sys.server\_principals u ON m.member\_principal\_id = u.principal\_id 
WHERE u.name = 'BUILTIN\\Administrators'

Make sure you have read this [tip](/sqlservertip/1017/security-issues-with-the-sql-server-builtin-administrators-group/) before you remove BUILTIN\\Administrators login from SQL Server.

### Find members of the "Local Administrators" group on SQL Server

If for some reason you want to keep the BUILTIN\\Administrators login you need to check who are the members of the "Local Administrators" group.

Note, that you will get results from the extended procedure below only if the BUILTIN\\Administrators group exists as login on SQL Server.

EXEC master.sys.xp\_logininfo 'BUILTIN\\Administrators','members'

### Find Sysadmins server role's members (and other server level roles)

This will show all logins and what server level roles each login has been assigned.

EXEC master.sys.sp\_helpsrvrolemember

Refer to this [tip](/sqlservertip/2809/auditing-sql-server-2012-server-roles/) for information about Server Roles Auditing using system views (including SQL Server 2012 user-defined server roles).

### Find db\_owner database role's members in each database

This will give you a list of database owners for each database.

EXEC master.sys.sp\_MSforeachdb '
PRINT ''?''
EXEC \[?\].dbo.sp\_helprolemember ''db\_owner'''

### Find logins mapped to the "dbo" user in each database

This will find all users that are mapped to the dbo schema.

EXEC master.sys.sp\_MSforeachdb '
PRINT ''?''
EXEC \[?\].dbo.sp\_helpuser ''dbo'''

### Check password policies and expiration for the SQL logins

This will check whether the password policy is turn on or off.

SELECT name  FROM sys.sql\_logins 
 WHERE  is\_policy\_checked=0 OR is\_expiration\_checked = 0

Refer to this [tip](/sqlservertip/1088/sql-server-login-properties-to-enforce-password-policies-and-expiration/) for more information about the "Enforce password policy" and the "Enforce password expiration" properties of the SQL Server Logins. This is also covered in another tip [here](/sqlservertip/1909/how-to-configure-password-enforcement-options-for-standard-sql-server-logins/).

### Check that Production and Test databases are segregated (on different SQL Servers)

This will look for the value of "Test" or "Dev" in all your database names.

SELECT name FROM master.sys.databases 
 WHERE name LIKE '%Test%' OR name LIKE '%Dev%'

### Check that sample databases (AdventureWorks, Pubs etc.) are not present on Production SQL Servers

This will check to see if these sample databases are present on your server.

SELECT name FROM master.sys.databases 
 WHERE name IN ('pubs', 'Northwind') OR name LIKE 'Adventure Works%'

### Verify that "sa" login has been renamed and/or disabled and has password policy/expiration enabled

This will check whether the sa password exists and if it does if the password policy is turned on for this login.

SELECT l.name, CASE WHEN l.name = 'sa' THEN 'NO' ELSE 'YES' END as Renamed,
  s.is\_policy\_checked, s.is\_expiration\_checked, l.is\_disabled
FROM sys.server\_principals AS l
 LEFT OUTER JOIN sys.sql\_logins AS s ON s.principal\_id = l.principal\_id
WHERE l.sid = 0x01

Refer to this [tip](/sqlservertip/1154/password-management-options-for-the-sql-server-sa-login/) for the options to make "sa" login secure.

### Check server configuration options

This will check different server configuration settings such as: allow updates, cross db ownership chaining, clr enabled, SQL Mail XPs, Database Mail XPs, xp\_cmdshell and Ad Hoc Distributed Queries.

SELECT name, value\_in\_use FROM sys.configurations
 WHERE configuration\_id IN (16391, 102, 400, 1562, 16386, 16385, 16390, 16393)

Configuration\_id 16393 is to check if "Contained Databases Authentication" option is enabled on SQL Server 2012. There are some potential security threats associated with contained databases that DBAs have to understand. Read more here: [Security Best Practices with Contained Databases](http://msdn.microsoft.com/en-us/library/ff929055.aspx).

Refer also to this [tip](/sqlservertip/1782/understanding-cross-database-ownership-chaining-in-sql-server/) to understand better the Cross Database Ownership Chaining feature.

### CONNECT or other permissions granted to the "guest" user

This will list what permission the guest user has.

SET NOCOUNT ON
CREATE TABLE #guest\_perms 
 ( db SYSNAME, class\_desc SYSNAME, 
  permission\_name SYSNAME, ObjectName SYSNAME NULL)
EXEC master.sys.sp\_MSforeachdb
'INSERT INTO #guest\_perms
 SELECT ''?'' as DBName, p.class\_desc, p.permission\_name, 
   OBJECT\_NAME (major\_id, DB\_ID(''?'')) as ObjectName
 FROM \[?\].sys.database\_permissions p JOIN \[?\].sys.database\_principals l
  ON p.grantee\_principal\_id= l.principal\_id 
 WHERE l.name = ''guest'' AND p.\[state\] = ''G'''
 
SELECT db AS DatabaseName, class\_desc, permission\_name, 
 CASE WHEN class\_desc = 'DATABASE' THEN db ELSE ObjectName END as ObjectName, 
 CASE WHEN DB\_ID(db) IN (1, 2, 4) AND permission\_name = 'CONNECT' THEN 'Default' 
  ELSE 'Potential Problem!' END as CheckStatus
FROM #guest\_perms
DROP TABLE #guest\_perms

Guest user by default has CONNECT permissions to the master, msdb and tempdb databases. Any other permissions will be returned by this query as potential problem. Refer to this [tip](/sqlservertip/1172/sql-server-database-guest-user-account/) for more information about guest user account.

### SQL Server Authentication mode

If this returns 0 the server uses both Windows and SQL Server security.  If the value is 1 it is only setup for Windows Authentication.

SELECT SERVERPROPERTY ('IsIntegratedSecurityOnly')

Check this [tip](/sqlservertip/2191/how-to-check-sql-server-authentication-mode-using-t-sql-and-ssms/) for different ways to check the SQL Server Authentication mode.

### SQL Server version

There are many different ways to find the SQL Server version. Here are some of them:

SELECT @@VERSION

  

SELECT SERVERPROPERTY('ProductVersion') AS ProductVersion,
 SERVERPROPERTY('ProductLevel') AS ProductLevel

The 'ProductLevel' property above will show Service Pack level as well (if it has been installed).

EXEC master.sys.xp\_msver

Check this [tip](/sqlservertip/1140/how-to-tell-what-sql-server-version-you-are-running/) for other ways to check the SQL Server version.

### Database users, permissions and application roles

This will give a list of permissions for each user.

\-- list of the users
EXEC sys.sp\_helpuser
-- database permissions
EXEC sys.sp\_helprotect
-- roles membership
EXEC sys.sp\_helprolemember
-- list of the database application roles
SELECT name FROM sys.database\_principals WHERE type = 'A'

Refer to [this tip](/sqlservertip/1071/auditing-your-sql-server-database-and-server-permissions/) for more information about permissions auditing.

### Location of Data and Log files

Quickly find databases that use only one drive:

SET NOCOUNT ON
CREATE TABLE #db\_drives (db SYSNAME, drive\_count INT)
EXEC master.sys.sp\_MSforeachdb
'INSERT INTO #db\_drives
 SELECT ''?'' AS DBName, 
  COUNT (DISTINCT LEFT(physical\_name, CHARINDEX( ''\\'', physical\_name,0)))
 FROM \[?\].sys.database\_files'
  
SELECT db AS DatabaseName
 FROM #db\_drives 
WHERE drive\_count = 1 AND DB\_ID(db) > 4
DROP TABLE #db\_drives

Check data and log files drives for the current database ('DriveLetter' column in the query below):

SELECT name, type\_desc, physical\_name, 
 LEFT(physical\_name, CHARINDEX( '\\', physical\_name,0)) AS DriveLetter
FROM sys.database\_files

### Check enabled Network Protocols

The query below will show if the Named Pipes protocol is enabled on SQL Server instance:

EXEC master.dbo.xp\_instance\_regread N'HKEY\_LOCAL\_MACHINE',
  N'Software\\Microsoft\\MSSQLServer\\MSSQLServer\\SuperSocketNetLib\\Np', 
  N'Enabled', 
  @NamedPipesEnabled OUTPUT
  
SELECT @NamedPipesEnabled AS NamedPipesEnabled

Refer to [this tip](/sqlservertip/2320/understanding-sql-server-net-libraries/) for more information about network protocols used by SQL Server.

### SQL Server Services Startup mode

The easiest way which will allow you as well to incorporate this check to your SQL scripts is to do this as described in [tip](/sqlservertip/2611/sql-services-status-check--an-evolution-part-3/):

SELECT \* FROM sys.dm\_server\_services

### Linked Servers and Linked Server Logins

This will provide a list of linked server and the logins used for linked servers.

\-- list of remote/linked servers
SELECT \* FROM sys.servers
-- linked server logins
EXEC master.sys.sp\_helplinkedsrvlogin 

### Find logins without permissions

This will find a list of logins that no permissions granted.  These logins if are not used could then be removed.

SET NOCOUNT ON
CREATE TABLE #all\_users (db VARCHAR(70), sid VARBINARY(85), stat VARCHAR(50))
EXEC master.sys.sp\_msforeachdb
'INSERT INTO #all\_users  
 SELECT ''?'', CONVERT(varbinary(85), sid) , 
  CASE WHEN  r.role\_principal\_id IS NULL AND p.major\_id IS NULL 
  THEN ''no\_db\_permissions''  ELSE ''db\_user'' END
 FROM \[?\].sys.database\_principals u LEFT JOIN \[?\].sys.database\_permissions p 
   ON u.principal\_id = p.grantee\_principal\_id  
   AND p.permission\_name <> ''CONNECT''
  LEFT JOIN \[?\].sys.database\_role\_members r 
   ON u.principal\_id = r.member\_principal\_id
  WHERE u.SID IS NOT NULL AND u.type\_desc <> ''DATABASE\_ROLE'''
IF EXISTS 
(SELECT l.name FROM sys.server\_principals l LEFT JOIN sys.server\_permissions p 
  ON l.principal\_id = p.grantee\_principal\_id  
  AND p.permission\_name <> 'CONNECT SQL'
 LEFT JOIN sys.server\_role\_members r 
  ON l.principal\_id = r.member\_principal\_id
 LEFT JOIN #all\_users u 
  ON l.sid= u.sid
 WHERE r.role\_principal\_id IS NULL  AND l.type\_desc <> 'SERVER\_ROLE' 
  AND p.major\_id IS NULL
 )
BEGIN
 SELECT DISTINCT l.name LoginName, l.type\_desc, l.is\_disabled, 
  ISNULL(u.stat + ', but is user in ' + u.db  +' DB', 'no\_db\_users') db\_perms, 
  CASE WHEN p.major\_id IS NULL AND r.role\_principal\_id IS NULL  
  THEN 'no\_srv\_permissions' ELSE 'na' END srv\_perms 
 FROM sys.server\_principals l LEFT JOIN sys.server\_permissions p 
   ON l.principal\_id = p.grantee\_principal\_id  
   AND p.permission\_name <> 'CONNECT SQL'
  LEFT JOIN sys.server\_role\_members r 
   ON l.principal\_id = r.member\_principal\_id
   LEFT JOIN #all\_users u 
   ON l.sid= u.sid
  WHERE  l.type\_desc <> 'SERVER\_ROLE' 
   AND ((u.db  IS NULL  AND p.major\_id IS NULL 
     AND r.role\_principal\_id IS NULL )
   OR (u.stat = 'no\_db\_permissions' AND p.major\_id IS NULL 
     AND r.role\_principal\_id IS NULL)) 
 ORDER BY 1, 4
END
DROP TABLE #all\_users 

The list returned by this query contains logins that should be reviewed and most likely have to be disabled or deleted:

![Review logins](/tipimages2/2887_IMG3.gif)

The last login in the list above still has user account in master database, but this user does not have any permissions on the database. This login could be deleted as well (after user's account deleted from the master database).

### Find broken database users on all databases (SQL logins mapping is broken)

These users are known as orphaned users because the associated link between the login and user is broken. Refer this [tip](/sqlservertip/1590/understanding-and-dealing-with-orphaned-users-in-a-sql-server-database/) for more information and how to fix these.

EXEC master.sys.sp\_msforeachdb '
print ''?''
EXEC \[?\].dbo.sp\_change\_users\_login ''report'''

### Find orphaned users in all of the databases (no logins exist for the database users)

Make sure you ran the previous check and fixed SQL Server logins before running this check.

SET NOCOUNT ON
CREATE TABLE #orph\_users (db SYSNAME, username SYSNAME, 
    type\_desc VARCHAR(30),type VARCHAR(30))
EXEC master.sys.sp\_msforeachdb  
'INSERT INTO #orph\_users
 SELECT ''?'', u.name , u.type\_desc, u.type
 FROM  \[?\].sys.database\_principals u 
  LEFT JOIN  \[?\].sys.server\_principals l ON u.sid = l.sid 
 WHERE l.sid IS NULL 
  AND u.type NOT IN (''A'', ''R'', ''C'') -- not a db./app. role or certificate
  AND u.principal\_id > 4 -- not dbo, guest or INFORMATION\_SCHEMA
  AND u.name NOT LIKE ''%DataCollector%'' 
  AND u.name NOT LIKE ''mdw%'' -- not internal users in msdb or MDW databases'
    
 SELECT \* FROM #orph\_users
 
 DROP TABLE #orph\_users

### Validate logins (identify orphaned Windows logins)

This check will show Windows logins that have been deleted from the server or Active Directory. Read more about this stored procedure in this [tip](/sqlservertip/1864/identify-orphaned-windows-logins-and-groups-in-sql-server-with-spvalidatelogins/).

EXEC master.sys.sp\_validatelogins

### Backups verification report

Check if a Full backup exists that is not older than 7 days, a Differential backup exists that is not older than 2 days or a Transaction Log backup exists that is not older than 1 day (you can change the number of days based on your requirements):

SELECT m.name AS DatabaseName, DATABASEPROPERTYEX(m.name, 'Recovery') AS RecoveryMode,
 CASE WHEN ISNULL(MAX(b.backup\_finish\_date), GETDATE()-10000) < GETDATE()-7 
    AND b.\[type\] = 'D' THEN 'Problem!' 
   WHEN ISNULL(MAX(b.backup\_finish\_date), GETDATE()-10000) < GETDATE()-2 
     AND b.\[type\] = 'I' THEN 'Problem!' 
   WHEN ISNULL(MAX(b.backup\_finish\_date), GETDATE()-10000) < GETDATE()-1 
     AND b.\[type\] = 'L' THEN 'Problem!' 
   ELSE 'OK' END AS BackupStatus,
    CASE WHEN b.\[type\] = 'D'  THEN 'Full' 
   WHEN b.\[type\] = 'I'  THEN 'Differential'
   WHEN b.\[type\] = 'L'  THEN 'Transaction Log'  END AS BackupType, 
 MAX(b.backup\_finish\_date) AS backup\_finish\_date
  FROM master.sys.databases m LEFT JOIN msdb.dbo.backupset b
  ON m.name = b.database\_name 
WHERE m.database\_id NOT IN (2,3) 
  AND DATABASEPROPERTYEX(m.name, 'Updateability') <> 'READ\_ONLY'
GROUP BY m.name, b.\[type\] 
HAVING ISNULL(MAX(b.backup\_finish\_date), GETDATE()-11) > GETDATE() - 10 
  OR MAX(b.backup\_finish\_date) IS NULL
ORDER BY m.name, backup\_finish\_date 

You can also use the SSMS built-in report to review a database's backup and restore events:

![Navigate to the report](/tipimages2/2887_IMG1.gif)

  

![Backup and Restore Report](/tipimages2/2887_IMG2.gif)

  

These scripts will be a good start for you to check your SQL Servers' security and settings. I provided scripts in SQL format for the most checks. This will allow you to put it all together and create your own report for all these checks.

##### Next Steps

*   Run the scripts on multiple servers using Central Management Server as in this [tip](/sqlservertip/1767/execute-sql-server-query-on-multiple-servers-at-the-same-time/).
*   Fix found issues.
*   Save results for the auditors.
*   Modify provided scripts to find other issues (for example, logins with server level permissions only).
*   Read more [Auditing and Compliance Tips](/sql-server-tip-category/35/auditing-and-compliance/).

  
  

[![sql server categories](/images/bimg-cat-250x125.png)](https://www.mssqltips.com/sql-server-categories/)

  

[![sql server webinars](/images/bimg-webinar-250x125.png)](https://www.mssqltips.com/sql-server-webcasts/)

  

[![subscribe to mssqltips](/images/bimg-join-250x125.png)](https://www.mssqltips.com/get-free-sql-server-tips/?ref=bimgs)

  

[![sql server tutorials](/images/bimg-tutorial-250x125.png)](https://www.mssqltips.com/sql-server-tutorials/)

  

[![sql server white papers](/images/bimg-whitepaper-250x125.png)](https://www.mssqltips.com/sql-server-whitepapers/)

  

[![next tip](/images/bimg-nexttip-250x125.png)](/sql-server-tip-category/35/auditing-and-compliance/)

  

  
  

##### About the author

[![MSSQLTips author Svetlana Golovko](/images/SvetlanaGolovko.jpg)](/sqlserverauthor/94/svetlana-golovko/) Svetlana Golovko is a DBA with 13 years of the IT experience (including SQL Server and Oracle) with main focus on performance.  
  
This author pledges the content of this article is based on professional experience and not AI generated.  
  
**[View all my tips](/sqlserverauthor/94/svetlana-golovko/)**

  
  

* * *

Comments For This Article
-------------------------

Add Comment

.ForumPostBodyArea { width: 100%; vertical-align: top; overflow: auto; }  
  
  

**Sunday, November 20, 2016 - 9:42:39 AM - steve sofar**

[Back To Top](#top "read the tip") (43807)

 Very very nice compilation of great informations and settings

Thank you so much for this great work

  

**Friday, February 13, 2015 - 12:53:12 PM - Leon Orlov**

[Back To Top](#top "read the tip") (36235)

Great collection of scripts. Thank you for sharing.

  

**Tuesday, July 15, 2014 - 10:46:30 AM - kumar**

[Back To Top](#top "read the tip") (32712)

The best site for MSSQL. I always prefer this for my cross reference.. Appriciated your hardwork Svetlana.

  

  

**Friday, January 24, 2014 - 8:23:54 PM - Svetlana Golovko**

[Back To Top](#top "read the tip") (28221)

Hi Brascon,

You can setup server side trace similar to this:http://www.mssqltips.com/sqlservertip/1035/sql-server-performance-statistics-using-a-server-side-trace/

Just add different events when set events with sp\_trace\_setevent (for example "Audit Add DB User Event").

  

**Monday, January 20, 2014 - 6:19:08 AM - Brascon**

[Back To Top](#top "read the tip") (28139)

Thank you very much Svetlana Golovko, this is really helpfull for new DBA as me, i am having an issue, we are using sql 2008 standard and i can not enable auditing, there i d like to audit the users account in the sysadmin role, some users get removed now and then, i would like to track who is removing the users, can you please assist me, much appreciated. Regars  

  

**Wednesday, July 10, 2013 - 2:39:54 PM - aMSdeveloper**

[Back To Top](#top "read the tip") (25780)

We all are requested to do many things in our day to day jobs but if only we all could collaborate and share information like in this post, we could be so much more better at what we do. Long story short, Thanks for posting this amazing and useful information. Very useful, and this is exactly what I was looking for.

  

**Wednesday, April 10, 2013 - 10:39:16 AM - James Lawrence**

[Back To Top](#top "read the tip") (23276)

Very useful information. Thanks for putting this all together! I will definitely use these...

  

**Tuesday, April 9, 2013 - 9:02:47 PM - Svetlana Golovko**

[Back To Top](#top "read the tip") (23263)

Hi Anil,

There are great "DMV a Day Series" by Glenn Berry here: [http://sqlserverperformance.wordpress.com/2010/05/02/recap-of-april-2010-dmv-a-day-series/.](http://sqlserverperformance.wordpress.com/2010/05/02/recap-of-april-2010-dmv-a-day-series/)

  

**Tuesday, April 9, 2013 - 5:38:02 AM - Anil**

[Back To Top](#top "read the tip") (23248)

Dear Svetlana,

Great Job, Those are really awesome and worthful. Great Post. and small request from me, please post Various DMV's and how they are useful in our regular DBA Job Operations.

  

**Monday, March 18, 2013 - 7:25:12 PM - Svetlana Golovko**

[Back To Top](#top "read the tip") (22857)

Thank you for your feedback, Srinivas. I am pleased that other DBAs find it helpful.

  

**Monday, March 18, 2013 - 6:48:05 AM - Srinivas**

[Back To Top](#top "read the tip") (22845)

Excellent Post Svetlana. Very helpful code(s) provided for all DBA's

  

**Thursday, March 7, 2013 - 6:06:44 PM - Svetlana Golovko**

[Back To Top](#top "read the tip") (22639)

Thank you, Nahid.

  

**Thursday, March 7, 2013 - 2:28:30 PM - Nahid**

[Back To Top](#top "read the tip") (22637)

 What a great collection of code handy to any DBA level. Well done . thanks

  

div.stickyright { position: -webkit-sticky; position: sticky; padding: 0; background-color: white; width: 300px; z-index: 1; }

  

  
  
  

  
  
  

  
  
  

  
  
  
function ValidateEmail(inputText) { if (document.optin.consent.checked == false) { alert("Please agree to terms by ticking check box."); return false; } var mailformat = /^((\[^<>()\\\[\\\]\\\\.,;:\\s@"\]+(\\.\[^<>()\\\[\\\]\\\\.,;:\\s@"\]+)\*)|(".+"))@((\\\[\[0-9\]{1,3}\\.\[0-9\]{1,3}\\.\[0-9\]{1,3}\\.\[0-9\]{1,3}\])|((\[a-zA-Z\\-0-9\]+\\.)+\[a-zA-Z\]{2,}))$/; if(inputText.value.match(mailformat)) { document.optin.ea.focus(); return true; } else { alert("You have entered an invalid email address!"); document.optin.ea.focus(); return false; } }

[![get free sql tips](/images/GetFreeSQLTips_black_box.png)](/get-free-sql-server-tips/?ref=LeftGFSTSlant)

 

[![agree to terms](/images/mssqltips-agree-terms.png)](/privacy/)

  
  

/\* Sidebar styles \*/ .sidebar { position: fixed; top: 50px; left: 0; height: 100%; width: 300px; background: white; padding: 6px 14px; z-index: 99; overflow-x: scroll; } /\* Main content styles \*/ .main-content { position: relative; margin-left: 300px; padding: 15px; width: calc(100% - 375x); max-width: calc(100% - 375px); } .footer { position: relative; margin-left: 300px; padding: 15px; } /\* Responsive styles \*/ @media screen and (max-width: 1400px) { .sidebar { left: -300px; } .main-content { margin-left: 0; width: 100%; max-width: 100%; } .footer { margin-left: 0; } #sidebarleft { color: white; background-color: #ffffff; left: 45px; top: 45px; bottom: 0px; padding: 10px; overflow: auto; font-size: 14px; line-height: 14px; } #sidebarleft > #sidebarheader { color: red; text-align: center; font-size: 18px; line-height: 18px; } #sidebarleft > p { font-size: 14px; line-height: 16px; padding: -5px; } /\* Style the tab \*/ .tab { overflow: hidden; border: 0px solid #FFFFFF; background-color: #000000; } /\* Style the buttons inside the tab \*/ .tab button { background-color: inherit; float: left; border: 1px solid #FFFFFF; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 12px; } /\* Change background color of buttons on hover \*/ .tab button:hover { background-color: #3399FF; } /\* Create an active/current tablink class \*/ .tab button.active { background-color: #CC3300; } /\* Style the tab content \*/ .tabcontent { display: none; border: 1px solid #000000; border-top: none; } ::-webkit-input-placeholder { /\* WebKit, Blink, Edge \*/ color: #909; } :-moz-placeholder { /\* Mozilla Firefox 4 to 18 \*/ color: #909; opacity: 1; } ::-moz-placeholder { /\* Mozilla Firefox 19+ \*/ color: #909; opacity: 1; } :-ms-input-placeholder { /\* Internet Explorer 10-11 \*/ color: #909; } ::-ms-input-placeholder { /\* Microsoft Edge \*/ color: #909; } ::placeholder { /\* Most modern browsers support this now. \*/ color: #909; }

Related Categories Popular

Related Content

[SQL Server Login Properties to Enforce Password Policies and Expiration](/sqlservertip/1088/sql-server-login-properties-to-enforce-password-policies-and-expiration/)

[Auditing Failed Logins in SQL Server](/sqlservertip/1735/auditing-failed-logins-in-sql-server/)

[Identify SQL Server databases that are no longer in use](/sqlservertip/3171/identify-sql-server-databases-that-are-no-longer-in-use/)

[How to Filter a SQL Server Audit with a Predicate](/sqlservertip/7654/sql-server-audit-filtering/)

[Audit SQL Server Logins without filling up the Error Log](/sqlservertip/5154/audit-sql-server-logins-without-filling-up-the-error-log/)

[Auditing SQL Server Password Age](/sqlservertip/2379/auditing-sql-server-password-age/)

[Designing Tables for Audit Data in SQL Server](/sqlservertip/1468/designing-tables-for-audit-data-in-sql-server/)

[Tutorials](/sql-server-tutorials/)

[SQL Server Stored Procedures](/sqlservertutorial/160/sql-server-stored-procedure-tutorial/)

[SQL Server 101](/sqlservertutorial/9214/sql-server-101-tutorial-outline-and-overview/)

[SQL Server Date Functions](/sqlservertutorial/9379/sql-current-timestamp-function/)

[SQL Server String Functions](/sqlservertutorial/9347/sql-ascii-function/)

[SQL Server Backups](/sqlservertutorial/1/sql-server-backup-options-and-commands-tutorial/)

[Join MSSQLTips](/get-free-sql-server-tips/?ref=lr)

[Development](/sql-server-categories/)

[Date Functions](/sql-server-tip-category/121/dates/)

[T-SQL](/sql-server-tip-category/23/tsql/)

[System Functions](/sql-server-tip-category/159/functions-system/)

[JOIN Tables](/sql-server-tip-category/71/join-tables/)

[SQL Server Management Studio](/sql-server-tip-category/52/sql-server-management-studio/)

[Database Administration](/sql-server-categories/)

[Database Administration](/sql-server-tip-category/60/database-administration/)

[Backups](/sql-server-tip-category/161/backup/)

[Security](/sql-server-tip-category/19/security/)

[Performance](/sql-server-categories/)

[](/sql-server-categories/)

[](/sql-server-categories/)[Performance Tuning](/sql-server-tip-category/9/performance-tuning/)

[Monitoring](/sql-server-tip-category/54/monitoring/)

[Locking and Blocking](/sql-server-tip-category/61/locking-and-blocking/)

[Data Analytics \\ ETL](/sql-server-categories/)

[Power BI](/sql-server-tip-category/211/power-bi/)

[Microsoft Fabric](/sql-server-tip-category/274/microsoft-fabric/)

[Azure Data Factory](/sql-server-tip-category/245/azure-data-factory/)

[Integration Services](/sql-server-tip-category/17/integration-services-development/)

[Cloud](/sql-server-categories/)

[Azure](/sql-server-tip-category/87/azure/)

[Amazon AWS](/sql-server-tip-category/205/amazon-aws/)

Popular Articles

[SQL Date Format Options with SQL CONVERT Function](/sqlservertip/1145/date-and-time-conversions-using-sql-server/)

[SQL Date Format examples using SQL FORMAT Function](/sqlservertip/2655/format-sql-server-dates-with-format-function/)

[SQL Server CROSS APPLY and OUTER APPLY](/sqlservertip/1958/sql-server-cross-apply-and-outer-apply/)

[DROP TABLE IF EXISTS Examples for SQL Server](/sqlservertip/6769/sql-server-drop-table-if-exists/)

[SQL NOT IN Operator](/sqlservertip/6904/sql-not-in-operator/)

[SQL Server Cursor Example](/sqlservertip/1599/cursor-in-sql-server/)

[Rolling up multiple rows into a single row and column for SQL Server data](/sqlservertip/2914/rolling-up-multiple-rows-into-a-single-row-and-column-for-sql-server-data/)

[SQL CASE Statement in Where Clause to Filter Based on a Condition or Expression](/sqlservertip/7703/sql-case-in-where-clause/)

[Resolving could not open a connection to SQL Server errors](/sqlservertip/2340/resolving-could-not-open-a-connection-to-sql-server-errors/)

[SQL Convert Date to YYYYMMDD](/sqlservertip/6452/sql-convert-date-to-yyyymmdd/)

[How to tell what SQL Server versions you are running](/sqlservertip/1140/how-to-tell-what-sql-server-version-you-are-running/)

[SQL Server Loop through Table Rows without Cursor](/sqlservertip/6148/sql-server-loop-through-table-rows-without-cursor/)

function openTab(evt, tabName) { var i, tabcontent, tablinks; tabcontent = document.getElementsByClassName("tabcontent"); for (i = 0; i < tabcontent.length; i++) { tabcontent\[i\].style.display = "none"; } tablinks = document.getElementsByClassName("tablinks"); for (i = 0; i < tablinks.length; i++) { tablinks\[i\].className = tablinks\[i\].className.replace(" active", ""); } document.getElementById(tabName).style.display = "block"; evt.currentTarget.className += " active"; var v = document.getElementById("searchBox"); if (tabName == "Search") { v.style.display = "none"; } else { v.style.display = "block"; } } // Get the element with id="defaultOpen" and click on it document.getElementById("defaultOpen").click();

* * *

*   ### Follow
    
    *   [Get Free SQL Tips](/get-free-sql-server-tips/?ref=GetFooterMenu)
    *   [Twitter](https://twitter.com/mssqltips)
    *   [LinkedIn](https://www.linkedin.com/groups/2320891/)
    *   [Facebook](https://www.facebook.com/mssqltips/)
    *   [Pinterest](https://www.pinterest.com/mssqltips/)
    *   [RSS](https://feeds.feedburner.com/MSSQLTips-LatestSqlServerTips)
*   ### Learning
    
    *   [DBAs](/sql-server-dba-resources/)
    *   [Developers](/sql-server-developer-resources/)
    *   [BI Professionals](/sql-server-business-intelligence-resources/)
    *   [Careers](/sql-server-professional-development-resources/)
*   ### Resources
    
    *   [Tutorials](/sql-server-tutorials/)
    *   [Webcasts](/sql-server-webcasts/)
    *   [Whitepapers](/sql-server-whitepapers/)
    *   [Tools](/sql-server-tools/)
*   ### Search
    
    *   [Tip Categories](/sql-server-categories/)
    *   [Search By TipID](/search-tip-id/)
    *   [Authors](/sql-server-mssqltips-authors/)
*   ### Community
    
    *   [First Timer?](/learn-more-about-mssqltips/)
    *   [Pictures](/mssqltips-community/1/)
    *   [Contribute](/contribute/)
    *   [Event Calendar](/sql-server-event-list/)
    *   [Author of the Year](/mssqltips-author-of-year/)
*   ### More Info
    
    *   [Join](/get-free-sql-server-tips/?ref=JoinFooterMenu)
    *   [About](/about/)
    *   [Copyright](/copyright/)
    *   [Privacy](/privacy/)
    *   [Disclaimer](/disclaimer/)
    *   [Feedback](/feedback/)
    *   [Advertise](/advertise/)

* * *

Copyright (c) 2006-2024 [Edgewood Solutions, LLC](https://www.edgewoodsolutions.com) All rights reserved  
Some names and products listed are the registered trademarks of their respective owners.

#slideboxtop{ width:100%; height:50px; padding:0px; background-color:#FFFFFF; border-bottom:1px solid #000000; position:fixed; top: -350px; -moz-box-shadow:-2px 0px 5px #aaa; -webkit-box-shadow:-2px 0px 5px #aaa; /\* box-shadow:-2px 0px 5px #aaa; \*/ }

/\* DivTable.com \*/ .divTable{ display: table; width: 100%; } .divTableRow { display: table-row; } .divTableHeading { background-color: #EEE; display: table-header-group; } .divTableCell, .divTableHead { display: table-cell; padding: 3px 10px; text-align: center; vertical-align: middle; } .divTableHeading { background-color: #EEE; display: table-header-group; font-weight: bold; } .divTableFoot { background-color: #EEE; display: table-footer-group; font-weight: bold; } .divTableBody { display: table-row-group; }

[![MSSQLTips.com Home](https://www.mssqltips.com/images/mssqltips_logo_nodotcom_62x40.png)](/)

[![Learn more about our sponsor](https://www.mssqltips.com/absolutebm/banners/MSSQLTips_SIOSWP_180_GettingStarted_Jan2024_990x30.jpg)](/ss.asp?id=5859)

[Join MSSQLTips](/get-free-sql-server-tips/?ref=990x30Right)

var articleLength = $("article").find("p").length; $(document).foundation(); $(function() { $(window).scroll(function(){ if ($(window).scrollTop() > 250) $('#slideboxtop').animate({'top':'0px'}); else $('#slideboxtop').stop(true).animate({'top':'-250px'}); }); }); function includeHTML(divname) { var z, i, elmnt, file, xhttp; /\*loop through a collection of all HTML elements:\*/ z = document.getElementsByTagName("\*"); for (i = 0; i < z.length; i++) { elmnt = z\[i\]; /\*search for elements with a certain atrribute:\*/ file = elmnt.getAttribute(divname); if (file) { /\*make an HTTP request using the attribute value as the file name:\*/ xhttp = new XMLHttpRequest(); xhttp.onreadystatechange = function() { if (this.readyState == 4) { if (this.status == 200) {elmnt.innerHTML = this.responseText;} if (this.status == 404) {elmnt.innerHTML = "Page not found.";} /\*remove the attribute, and call this function once more:\*/ elmnt.removeAttribute(divname); includeHTML(); } } xhttp.open("GET", file, true); xhttp.send(); /\*exit the function:\*/ return; } } }; if ($(window).width() > 1000) { includeHTML('w3-include-html'); includeHTML('red-box'); $("div.rightsize").height($("#container").height()); } window.dataLayer = window.dataLayer || \[\]; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JQ9C1XQQJM');
